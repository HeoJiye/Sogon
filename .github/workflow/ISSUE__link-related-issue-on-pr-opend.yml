name: ğŸŒ¿ PRì´ ìƒì„±ë  ë•Œ

on:
  pull_request:
    types: [opened]

jobs:
  link-related-issues:
    name: ğŸ”— ê´€ë ¨ ì´ìŠˆë¥¼ ì—°ê²°í•œë‹¤
    runs-on: ubuntu-latest

    steps:
      - name: â‘  PR ì´ë¦„ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì°¾ê¸°
        id: extract_issue
        run: |
          ISSUE_NUMBER=$(echo "${{ github.event.pull_request.title }}" | grep -o -E "/#[0-9]+" | head -n 1 | tr -d '/#')
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_ENV

      - name: â‘¡ PR ë‚´ìš©ì— resolves ì´ìŠˆ ë²ˆí˜¸ ì¶”ê°€í•˜ê¸°
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ env.issue_number }}
        run: |
          # PR ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
          PR_BODY=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} | jq -r '.body')

          # resolves #ì´ìŠˆë²ˆí˜¸ ë¶™ì´ê¸°
          NEW_PR_BODY="resolves #$ISSUE_NUMBER\n\n$PR_BODY"

          # PR ë‚´ìš© ì—…ë°ì´íŠ¸
          curl -s -X PATCH -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"body\": \"$NEW_PR_BODY\"}" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}
